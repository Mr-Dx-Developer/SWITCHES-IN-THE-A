local weapons = {
    'WEAPON_KNIFE',
    'WEAPON_NIGHTSTICK',
    'WEAPON_BREAD',
    'WEAPON_FLASHLIGHT',
    'WEAPON_HAMMER',
    'WEAPON_BAT',
    'WEAPON_GOLFCLUB',
    'WEAPON_CROWBAR',
    'WEAPON_BOTTLE',
    'WEAPON_DAGGER',
    'WEAPON_HATCHET',
    'WEAPON_MACHETE',
    'WEAPON_SWITCHBLADE',
    'WEAPON_BATTLEAXE',
    'WEAPON_POOLCUE',
    'WEAPON_WRENCH',
    'WEAPON_PISTOL',
    'WEAPON_PISTOL_MK2',
    'WEAPON_COMBATPISTOL',
    'WEAPON_APPISTOL',
    'WEAPON_PISTOL50',
    'WEAPON_REVOLVER',
    'WEAPON_SNSPISTOL',
    'WEAPON_HEAVYPISTOL',
    'WEAPON_VINTAGEPISTOL',
    'WEAPON_MICROSMG',
    'WEAPON_SMG',
    'WEAPON_ASSAULTSMG',
    'WEAPON_MINISMG',
    'WEAPON_MACHINEPISTOL',
    'WEAPON_COMBATPDW',
    'WEAPON_PUMPSHOTGUN',
    'WEAPON_SAWNOFFSHOTGUN',
    'WEAPON_ASSAULTSHOTGUN',
    'WEAPON_BULLPUPSHOTGUN',
    'WEAPON_HEAVYSHOTGUN',
    'WEAPON_ASSAULTRIFLE',
    'WEAPON_CARBINERIFLE',
    'WEAPON_ADVANCEDRIFLE',
    'WEAPON_SPECIALCARBINE',
    'WEAPON_BULLPUPRIFLE',
    'WEAPON_COMPACTRIFLE',
    'WEAPON_MG',
    'WEAPON_COMBATMG',
    'WEAPON_GUSENBERG',
    'WEAPON_SNIPERRIFLE',
    'WEAPON_HEAVYSNIPER',
    'WEAPON_MARKSMANRIFLE',
    'WEAPON_GRENADELAUNCHER',
    'WEAPON_RPG',
    'WEAPON_STINGER',
    'WEAPON_MINIGUN',
    'WEAPON_GRENADE',
    'WEAPON_STICKYBOMB',
    'WEAPON_SMOKEGRENADE',
    'WEAPON_BZGAS',
    'WEAPON_MOLOTOV',
    'WEAPON_DIGISCANNER',
    'WEAPON_FIREWORK',
    'WEAPON_MUSKET',
    'WEAPON_STUNGUN',
    'WEAPON_HOMINGLAUNCHER',
    'WEAPON_PROXMINE',
    'WEAPON_FLAREGUN',
    'WEAPON_MARKSMANPISTOL',
    'WEAPON_RAILGUN',
    'WEAPON_DBSHOTGUN',
    'WEAPON_AUTOSHOTGUN',
    'WEAPON_COMPACTLAUNCHER',
    'WEAPON_PIPEBOMB',
    'WEAPON_DOUBLEACTION',
    'WEAPON_SNOWBALL',
    'WEAPON_PISTOLXM3',
    'WEAPON_CANDYCANE',
    'WEAPON_CERAMICPISTOL',
    'WEAPON_NAVYREVOLVER',
    'WEAPON_GADGETPISTOL',
    'WEAPON_PISTOLXM3',
    'WEAPON_TECPISTOL',
    'WEAPON_HEAVYRIFLE',
    'WEAPON_MILITARYRIFLE',
    'WEAPON_TACTICALRIFLE',
    'WEAPON_SWEEPERSHOTGUN',
    'WEAPON_ASSAULTRIFLE_MK2',
    'WEAPON_BULLPUPRIFLE_MK2',
    'WEAPON_CARBINERIFLE_MK2',
    'WEAPON_COMBATMG_MK2',
    'WEAPON_HEAVYSNIPER_MK2',
    'WEAPON_KNUCKLE',
    'WEAPON_MARKSMANRIFLE_MK2',
    'WEAPON_PRECISIONRIFLE',
    'WEAPON_PETROLCAN',
    'WEAPON_PUMPSHOTGUN_MK2',
    'WEAPON_RAYCARBINE',
    'WEAPON_RAYMINIGUN',
    'WEAPON_RAYPISTOL',
    'WEAPON_REVOLVER_MK2',
    'WEAPON_SMG_MK2',
    'WEAPON_SNSPISTOL_MK2',
    'WEAPON_SPECIALCARBINE_MK2',
    'WEAPON_STONE_HATCHET',
    -- NORMAL ADD ONS
    'WEAPON_GLOCK22',
    'WEAPON_M9',
     --ADD ONS
    'WEAPON_L85_CHRISTMAS',
    'WEAPON_NVRIFLE_PURPLE',
    'WEAPON_FAMAS_YELLOW',
    'WEAPON_AKPUV2',
    'WEAPON_M4A5V2',
    'WEAPON_FOOLV2_RED',
    'WEAPON_FOOLV2',
    'WEAPON_GALILARV2',
    'WEAPON_HK516V2',
    'WEAPON_HFSMGV2',
    'WEAPON_GRU2',
    'WEAPON_GRAUV2',
    'WEAPON_GYSV2',
    'WEAPON_NEVAV2',
    'WEAPON_MODULAR_RIFLE',
    'WEAPON_NVRIFLE',
    'WEAPON_M4_T_NEON',
    'WEAPON_M27S',
    'WEAPON_HKUSP',
    'WEAPON_M270D',
    'WEAPON_M4_HALLOWEEN',
    'WEAPON_FAMAS',
    'WEAPON_M4_A_W',
    'WEAPON_L85',
    'WEAPON_UMP',
    'WEAPON_MP5',
    'WEAPON_VECTOR',
    'WEAPON_BAS_P_RED',
    'WEAPON_SCEVO',
    'WEAPON_R90',
    'WEAPON_M133V3',
    'WEAPON_GAU_5A',
    'WEAPON_M82V2',
    'WEAPON_M47V2',
    'WEAPON_HOWAT20',
    'WEAPON_ISYV2',
    'WEAPON_M4A1_MOD',
    'WEAPON_BERYL_762',
    'WEAPON_M4_TACTICAL_RED',
    'WEAPON_AK47_NIGHTWISH',
    'WEAPON_XM7_6_8',
    'WEAPON_DESERT_EAGLE',
    'WEAPON_SCAR-L',
    'WEAPON_AWP_ASIIMOV',
    'WEAPON_P250_ASIIMOV',
    'WEAPON_P20_ASIIMOV',
    'WEAPON_AK47_ASIIMOV',
    'WEAPON_M4ASIIMOV',
    'WEAPON_LMTM4R',
    'WEAPON_BULLPUP_SMG',


    'WEAPON_PISTOL',
    'WEAPON_PISTOL_MK2',
    'WEAPON_COMBATPISTOL',
    'WEAPON_APPISTOL',
    'WEAPON_PISTOL50',
    'WEAPON_REVOLVER',
    'WEAPON_SNSPISTOL',
    'WEAPON_HEAVYPISTOL',
    'WEAPON_VINTAGEPISTOL',




    -- Melee
'weapon_dagger',
'weapon_bat',
'weapon_bottle',
'weapon_crowbar',
'weapon_golfclub',
'weapon_hammer',
'weapon_hatchet',
'weapon_knuckle',
'weapon_knife',
'weapon_machete',
'weapon_switchblade',
'weapon_wrench',
'weapon_battleaxe',
'weapon_poolcue',
'weapon_briefcase',
'weapon_briefcase_02',
'weapon_garbagebag',
'weapon_handcuffs',
'weapon_bread',
'weapon_stone_hatchet',

-- Handguns
'weapon_pistol',
'weapon_pistol_mk2',
'weapon_pistolxm3',
'weapon_combatpistol',
'weapon_appistol',
'weapon_pistol50',
'weapon_snspistol',
'weapon_heavypistol',
'weapon_vintagepistol',
'weapon_flaregun',
'weapon_marksmanpistol',
'weapon_revolver',
'weapon_revolver_mk2',
'weapon_doubleaction',
'weapon_snspistol_mk2',
'weapon_raypistol',
'weapon_ceramicpistol',
'weapon_navyrevolver',
'weapon_gadgetpistol',

-- Submachine Guns
'weapon_microsmg',
'weapon_smg',
'weapon_smg_mk2',
'weapon_assaultsmg',
'weapon_combatpdw',
'weapon_machinepistol',
'weapon_minismg',
'weapon_raycarbine',

-- Shotguns
'weapon_pumpshotgun',
'weapon_sawnoffshotgun',
'weapon_assaultshotgun',
'weapon_bullpupshotgun',
'weapon_musket',
'weapon_heavyshotgun',
'weapon_dbshotgun',
'weapon_autoshotgun',
'weapon_pumpshotgun_mk2',
'weapon_combatshotgun',

-- Assault Rifles
'weapon_assaultrifle',
'weapon_assaultrifle_mk2',
'weapon_carbinerifle',
'weapon_carbinerifle_mk2',
'weapon_tacticalrifle',
'weapon_advancedrifle',
'weapon_specialcarbine',
'weapon_bullpuprifle',
'weapon_compactrifle',
'weapon_specialcarbine_mk2',
'weapon_bullpuprifle_mk2',
'weapon_militaryrifle',
'weapon_heavyrifle',

-- Light Machine Guns
'weapon_mg',
'weapon_combatmg',
'weapon_gusenberg',
'weapon_combatmg_mk2',

-- Sniper Rifles
'weapon_sniperrifle',
'weapon_heavysniper',
'weapon_marksmanrifle',
'weapon_remotesniper',
'weapon_heavysniper_mk2',
'weapon_marksmanrifle_mk2',

-- Heavy Weapons
'weapon_rpg',
'weapon_grenadelauncher',
'weapon_grenadelauncher_smoke',
'weapon_emplauncher',
'weapon_minigun',
'weapon_firework',
'weapon_railgun',
'weapon_hominglauncher',
'weapon_compactlauncher',
'weapon_rayminigun',

-- Throwables
'weapon_grenade',
'weapon_bzgas',
'weapon_molotov',
'weapon_stickybomb',
'weapon_proxmine',
'weapon_snowball',
'weapon_pipebomb',
'weapon_ball',
'weapon_smokegrenade',
'weapon_flare',


'weapon_petrolcan',
'weapon_fireextinguisher',
'weapon_hazardcan',
'weapon_fertilizercan',

-- Custom Weapons NoobySloth (it is possible that some weapon is broken)
-- ref: https://github.com/NoobySloth/Custom-Weapons
'weapon_ak47',
'weapon_de',
'weapon_fnx45',
'weapon_glock17',
'weapon_m4',
'weapon_hk416',
'weapon_mk14',
'weapon_m110',
'weapon_huntingrifle',
'weapon_ar15',
'weapon_m9',
'weapon_m70',
'weapon_m1911',
'weapon_mac10',
'weapon_uzi',
'weapon_mp9',
'weapon_mossberg',
'weapon_remington',
'weapon_scarh',
'weapon_shiv',
'weapon_katana',
'weapon_sledgehammer',
'weapon_mp5',
'weapon_glock18c',
'weapon_glock22',
'weapon_aks74',
'weapon_ak74',



-- KYROS WEAPON PACK V5
'weapon_bar15',
'weapon_axe',
'weapon_blackarp',
'weapon_bscar',
'weapon_thompson',
'weapon_blueglocks',
'weapon_chair',
'weapon_dmk18',
'weapon_fn57',
'weapon_glock21',
'weapon_glock41',
'weapon_glockbeams',
'weapon_p30l',
'weapon_illglock17',
'weapon_krissvector',
'weapon_lbtarp',
'weapon_mgglock',
'weapon_midasglock',
'weapon_m500',
'weapon_p210',
'weapon_ram7',
'weapon_redarp',
'weapon_redm4a1',
'weapon_r590',
'weapon_sr40',
'weapon_t1911',
'weapon_tarp',
'weapon_tglock19',
'weapon_tec9s',
'weapon_woarp',


-- KYROS WEAPON PACK V4
'weapon_glock19x',
'weapon_glock19',
'weapon_glock40',
'weapon_glock40s',
'weapon_ddm4v5',
'weapon_mpx',
'weapon_pd509',
'weapon_aps',
'weapon_ppk',
'weapon_pitviper',
'weapon_barp',
'weapon_rdp',
'weapon_lok',
'weapon_plr',
'weapon_xds9',
'weapon_pps',
'weapon_xdme',
'weapon_sp',
'weapon_glock17s',
'weapon_glock18c',
'weapon_glock19s',
'weapon_arpistol',
'weapon_glock26s',
'weapon_grenades',
'weapon_m32s',
'weapon_microdraco',
'weapon_ruger57',
'weapon_mk18',
'weapon_680',
'weapon_ziptie',
-- KYROS WEAPON PACK V3
'weapon_m32',
"weapon_ddm4v7",
"weapon_g2c",
"weapon_pmr",
"weapon_g19g4",
"weapon_gs",
"weapon_sp320",
"weapon_bp",
"weapon_tglock",
"weapon_g19x",
"weapon_awp",
"weapon_tuzi",
"weapon_broom",
"weapon_tomahawk",
"weapon_tridagger",
"weapon_shammer",
"weapon_dildo",
"weapon_uk",
"weapon_sd",
"weapon_m200",
"weapon_scar",
"weapon_552",
"weapon_l1a1",
"weapon_fal",
"weapon_mcx",
"weapon_p2011",
"weapon_p416",
"weapon_hipoint",
"weapon_de",
"weapon_auga1",
"weapon_p90",
"weapon_vesper",
"weapon_h12",
"weapon_g26",
"weapon_ia2",
"weapon_as50",
"weapon_jrbak",
"weapon_neva",
"weapon_howa_2",
"weapon_glacier",
"weapon_anarchy",
"weapon_art64",
"weapon_autosmg",
"WEAPON_BAS_P_RED",
"CZ Scorpion EVO",
"weapon_galilar",



    --Custom Weapon
	-- 'WEAPON_AK47',
	-- 'WEAPON_M9',
	-- 'WEAPON_FNX45',
	-- 'WEAPON_DE',
	-- 'WEAPON_GLOCK17',
	-- 'WEAPON_M4',
	-- 'WEAPON_HK416',
	-- 'WEAPON_MK14',
	-- 'WEAPON_HUNTINGRIFLE',
	-- 'WEAPON_AR15',
	-- 'WEAPON_M70',
	-- 'WEAPON_M1911',
	-- 'WEAPON_MAC10',
	-- 'WEAPON_UZI',
	-- 'WEAPON_MP9',
	-- 'WEAPON_M110',
	-- 'WEAPON_MOSSBERG',
	-- 'WEAPON_REMINGTON',
	-- 'WEAPON_SCARH',
	-- 'WEAPON_SHIV',
	-- 'WEAPON_KATANA',
	-- 'WEAPON_SLEDGEHAMMER',
	-- 'WEAPON_COLBATON',
	-- 'WEAPON_MP5',
	-- 'WEAPON_GLOCK18C',
	-- 'WEAPON_GLOCK22',
	-- 'WEAPON_AKS74',
	-- 'WEAPON_AK74'
}

local holstered = true
local canFire = true
local currWeap = `WEAPON_UNARMED`
local currHolster = nil
local currHolsterTexture = nil
local wearingHolster = nil

local function loadAnimDict(dict)
    if HasAnimDictLoaded(dict) then return end
    RequestAnimDict(dict)
    while not HasAnimDictLoaded(dict) do
        Wait(10)
    end
end

local function checkWeapon(newWeap)
    for i = 1, #weapons do
        if joaat(weapons[i]) == newWeap then
            return true
        end
    end
    return false
end

local function isWeaponHolsterable(weap)
    for i = 1, #Config.WeapDraw.weapons do
        if joaat(Config.WeapDraw.weapons[i]) == weap then
            return true
        end
    end
    return false
end

RegisterNetEvent('weapons:ResetHolster', function()
    holstered = true
    canFire = true
    currWeap = `WEAPON_UNARMED`
    currHolster = nil
    currHolsterTexture = nil
    wearingHolster = nil
end)

RegisterNetEvent('weapons:client:DrawWeapon', function()
    if GetResourceState('qs-inventory') == 'missing' then return end
    local sleep
    local weaponCheck = 0
    while true do
        local ped = PlayerPedId()
        sleep = 250
        if DoesEntityExist(ped) and not IsEntityDead(ped) and not IsPedInParachuteFreeFall(ped) and not IsPedFalling(ped) and (GetPedParachuteState(ped) == -1 or GetPedParachuteState(ped) == 0) then
            sleep = 0
            if currWeap ~= GetSelectedPedWeapon(ped) then
                local pos = GetEntityCoords(ped, true)
                local rot = GetEntityHeading(ped)

                local newWeap = GetSelectedPedWeapon(ped)
                SetCurrentPedWeapon(ped, currWeap, true)
                loadAnimDict('reaction@intimidation@1h')
                loadAnimDict('reaction@intimidation@cop@unarmed')
                loadAnimDict('rcmjosh4')
                loadAnimDict('weapons@pistol@')

                local holsterVariant = GetPedDrawableVariation(ped, 8)
                wearingHolster = false
                for i = 1, #Config.WeapDraw.variants, 1 do
                    if holsterVariant == Config.WeapDraw.variants[i] then
                        wearingHolster = true
                    end
                end
                if checkWeapon(newWeap) then
                    if holstered then
                        if wearingHolster then
                            --TaskPlayAnim(ped, 'rcmjosh4', 'josh_leadout_cop2', 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
                            canFire = false
                            CeaseFire()
                            currHolster = GetPedDrawableVariation(ped, 7)
                            currHolsterTexture = GetPedTextureVariation(ped, 7)
                            TaskPlayAnimAdvanced(ped, 'rcmjosh4', 'josh_leadout_cop2', pos.x, pos.y, pos.z, 0, 0, rot, 3.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(300)
                            SetCurrentPedWeapon(ped, newWeap, true)

                            if isWeaponHolsterable(newWeap) then
                                SetPedComponentVariation(ped, 7, currHolster == 8 and 2 or currHolster == 1 and 3 or currHolster == 6 and 5, currHolsterTexture, 2)
                            end
                            currWeap = newWeap
                            Wait(300)
                            ClearPedTasks(ped)
                            holstered = false
                            canFire = true
                        else
                            canFire = false
                            CeaseFire()
                            TaskPlayAnimAdvanced(ped, 'reaction@intimidation@1h', 'intro', pos.x, pos.y, pos.z, 0, 0, rot, 8.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(1000)
                            SetCurrentPedWeapon(ped, newWeap, true)
                            currWeap = newWeap
                            Wait(1400)
                            ClearPedTasks(ped)
                            holstered = false
                            canFire = true
                        end
                    elseif newWeap ~= currWeap and checkWeapon(currWeap) then
                        if wearingHolster then
                            canFire = false
                            CeaseFire()

                            TaskPlayAnimAdvanced(ped, 'reaction@intimidation@cop@unarmed', 'intro', pos.x, pos.y, pos.z, 0, 0, rot, 3.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(500)

                            if isWeaponHolsterable(currWeap) then
                                SetPedComponentVariation(ped, 7, currHolster, currHolsterTexture, 2)
                            end

                            SetCurrentPedWeapon(ped, `WEAPON_UNARMED`, true)
                            currHolster = GetPedDrawableVariation(ped, 7)
                            currHolsterTexture = GetPedTextureVariation(ped, 7)

                            TaskPlayAnimAdvanced(ped, 'rcmjosh4', 'josh_leadout_cop2', pos.x, pos.y, pos.z, 0, 0, rot, 3.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(300)
                            SetCurrentPedWeapon(ped, newWeap, true)

                            if isWeaponHolsterable(newWeap) then
                                SetPedComponentVariation(ped, 7, currHolster == 8 and 2 or currHolster == 1 and 3 or currHolster == 6 and 5, currHolsterTexture, 2)
                            end

                            Wait(500)
                            currWeap = newWeap
                            ClearPedTasks(ped)
                            holstered = false
                            canFire = true
                        else
                            canFire = false
                            CeaseFire()
                            TaskPlayAnimAdvanced(ped, 'reaction@intimidation@1h', 'outro', pos.x, pos.y, pos.z, 0, 0, rot, 8.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(1600)
                            SetCurrentPedWeapon(ped, `WEAPON_UNARMED`, true)
                            TaskPlayAnimAdvanced(ped, 'reaction@intimidation@1h', 'intro', pos.x, pos.y, pos.z, 0, 0, rot, 8.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(1000)
                            SetCurrentPedWeapon(ped, newWeap, true)
                            currWeap = newWeap
                            Wait(1400)
                            ClearPedTasks(ped)
                            holstered = false
                            canFire = true
                        end
                    else
                        if wearingHolster then
                            SetCurrentPedWeapon(ped, `WEAPON_UNARMED`, true)
                            currHolster = GetPedDrawableVariation(ped, 7)
                            currHolsterTexture = GetPedTextureVariation(ped, 7)
                            TaskPlayAnimAdvanced(ped, 'rcmjosh4', 'josh_leadout_cop2', pos.x, pos.y, pos.z, 0, 0, rot, 3.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(300)
                            SetCurrentPedWeapon(ped, newWeap, true)

                            if isWeaponHolsterable(newWeap) then
                                SetPedComponentVariation(ped, 7, currHolster == 8 and 2 or currHolster == 1 and 3 or currHolster == 6 and 5, currHolsterTexture, 2)
                            end

                            currWeap = newWeap
                            Wait(300)
                            ClearPedTasks(ped)
                            holstered = false
                            canFire = true
                        else
                            SetCurrentPedWeapon(ped, `WEAPON_UNARMED`, true)
                            TaskPlayAnimAdvanced(ped, 'reaction@intimidation@1h', 'intro', pos.x, pos.y, pos.z, 0, 0, rot, 8.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(1000)
                            SetCurrentPedWeapon(ped, newWeap, true)
                            currWeap = newWeap
                            Wait(1400)
                            ClearPedTasks(ped)
                            holstered = false
                            canFire = true
                        end
                    end
                else
                    if not holstered and checkWeapon(currWeap) then
                        if wearingHolster then
                            canFire = false
                            CeaseFire()
                            TaskPlayAnimAdvanced(ped, 'reaction@intimidation@cop@unarmed', 'intro', pos.x, pos.y, pos.z, 0, 0, rot, 3.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(500)

                            if isWeaponHolsterable(currWeap) then
                                SetPedComponentVariation(ped, 7, currHolster, currHolsterTexture, 2)
                            end

                            SetCurrentPedWeapon(ped, `WEAPON_UNARMED`, true)
                            ClearPedTasks(ped)
                            SetCurrentPedWeapon(ped, newWeap, true)
                            holstered = true
                            canFire = true
                            currWeap = newWeap
                        else
                            canFire = false
                            CeaseFire()
                            TaskPlayAnimAdvanced(ped, 'reaction@intimidation@1h', 'outro', pos.x, pos.y, pos.z, 0, 0, rot, 8.0, 3.0, -1, 50, 0, 0, 0)
                            Wait(1400)
                            SetCurrentPedWeapon(ped, `WEAPON_UNARMED`, true)
                            ClearPedTasks(ped)
                            SetCurrentPedWeapon(ped, newWeap, true)
                            holstered = true
                            canFire = true
                            currWeap = newWeap
                        end
                    else
                        SetCurrentPedWeapon(ped, newWeap, true)
                        holstered = false
                        canFire = true
                        currWeap = newWeap
                    end
                end
            end
        end
        Wait(sleep)
        if currWeap == nil or currWeap == `WEAPON_UNARMED` then
            weaponCheck += 1
            if weaponCheck == 2 then
                break
            end
        end
    end
end)

function CeaseFire()
    CreateThread(function()
        if GetResourceState('qs-inventory') == 'missing' then return end
        while not canFire do
            DisableControlAction(0, 25, true)
            DisablePlayerFiring(PlayerId(), true)
            Wait(0)
        end
    end)
end