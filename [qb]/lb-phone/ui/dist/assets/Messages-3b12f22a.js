var Re=Object.defineProperty;var _e=(t,n,E)=>n in t?Re(t,n,{enumerable:!0,configurable:!0,writable:!0,value:E}):t[n]=E;var ae=(t,n,E)=>(_e(t,typeof n!="symbol"?n+"":n,E),E);import{r as m,j as e,F as ie,a as c}from"./jsx-runtime-f40812bf.js";import{w as Ve,d as D,x as $e,f as k,u as ne,y as be,L as r,k as x,m as Fe,z as Ce,I as re,C as F,h as Z,A as Pe,o as X,v as Ye,B as Ae,b as q,D as je,E as Ne,F as le,i as xe,n as He,p as Te,j as K,G as Xe,H as Be}from"./Phone-cc49d184.js";import{u as R,A as me,a as qe,ai as We,d as de,Z as Ge,aj as ze,g as we,ak as Qe,K as Ke,c as Je,m as ce,al as Ze,ab as et,ac as tt,am as st,z as at,s as Ie,V as nt,an as rt}from"./index.esm-497ba86e.js";import{r as Me,f as ve}from"./number-28525126.js";const pe=(t,n=25,E=7,T=360,P=120)=>new Promise((a,i)=>{let l=document.createElement("canvas");l.width=T,l.height=P;let u=l.getContext("2d");u.fillStyle="#000";let N=new AudioContext;t.arrayBuffer().then(o=>N.decodeAudioData(o)).then(o=>{let d=(l.width-(n-1)*E)/n,A=l.height/2,w=Math.floor(o.length/n),S=o.getChannelData(0);for(let I=0;I<n;I++){let U=1,V=.1;for(let O=0;O<w;O++){let b=S[I*w+O];b<U&&(U=b),b>V&&(V=b)}let $=(1+U)*A,Y=(V-U)*A;u.beginPath(),u.moveTo(I*(d+E),$),u.lineTo(I*(d+E),$+Y),u.lineTo(I*(d+E)+d,$+Y),u.lineTo(I*(d+E)+d,$),u.closePath(),u.fill()}l.toBlob(I=>a({blob:I,base64:l.toDataURL()}))})});class it{constructor(){ae(this,"recorder");ae(this,"chunks");ae(this,"stream");ae(this,"start",async()=>{if(!this.stream){const n=await Ve("AudioRecorder");if(!n)return D("error","AudioRecorder: Failed to get audio stream");this.stream=n}this.recorder=new MediaRecorder(this.stream),this.recorder.ondataavailable=n=>this.chunks.push(n.data),this.chunks=[],this.recorder.start()});this.recorder=null,this.chunks=[]}stop(){const{recorder:n,chunks:E}=this;return n?new Promise(T=>{n.onstop=()=>{const P=new Blob(E,{type:n.mimeType}),a=new Audio;a.src=URL.createObjectURL(P),this.stream&&$e("AudioRecorder");let i={blob:P};pe(P).then(l=>{pe(P,60,7,960,200).then(u=>{i.waveform={message:l.blob,placeholder:u.base64},a.duration===1/0?(a.currentTime=Number.MAX_SAFE_INTEGER,a.ontimeupdate=()=>T({...i,duration:Math.floor(a.duration+.5)})):T({...i,duration:Math.floor(a.duration+.5)})})})},n.stop()}):D("error","AudioRecorder: Failed to end recording: not recording")}}function lt(){const{User:t,View:n,UnreadMessages:E}=m.useContext(ee),T=R(q.Settings),P=R(q.PhoneNumber),[a,i]=t,[l,u]=n,[N,o]=E,d=R(F.Emoji),[A,w]=m.useState(!1),[S,I]=m.useState(null),[U,V]=m.useState(!1),[$,Y]=m.useState(!1),[O,b]=m.useState(0),[J,B]=m.useState(0),[f,G]=m.useState(!1),[_,M]=m.useState(!1),[v,p]=m.useState([]),[g,L]=m.useState(null),te=m.useRef(null),ue=m.useRef(0),[j,se]=m.useState({content:"",attachments:[]}),H=R(Z);m.useEffect(()=>{k("Messages",{action:"getMessages",page:0,id:a.id}).then(s=>{s&&s.length>0?p([...s.reverse()]):G(!0)})},[]);const oe=m.useRef(!1),Se=()=>{if(j.content.length<=0&&j.attachments.length<=0&&!g)return D("info","Message is empty, returning");let s={sender:P,timestamp:Date.now(),id:a.id,content:j.content,attachments:j.attachments};if(g){if(oe.current)return;oe.current=!0,Pe("Image",g.waves.message).then(h=>{Pe("Audio",g.blob).then(C=>{s.content=`<!AUDIO-MESSAGE-IMAGE="${h}"-AUDIO="${C}"-DURATION="${g.duration}"!>`,k("Messages",{action:"sendMessage",number:a.number,content:s.content,id:a.id}).then(y=>{p(y?Q=>[...Q,{...s,id:y.messageId}]:Q=>[...Q,{...s,delivered:!1}]),oe.current=!1,L(null)})})});return}if(!ke(j.content))return D("error","Message contains invalid characters, returning",j.content);if(T.airplaneMode)return p(h=>[...h,{...s,delivered:!1}]);k("Messages",{action:"sendMessage",number:a.number,content:j.content,attachments:j.attachments,id:a.id}).then(h=>{h?(p(C=>[...C,{...s,id:h.messageId}]),L(null)):p(C=>[...C,{...s,delivered:!1}]),se({content:"",attachments:[]}),te.current&&(te.current.value=""),D("info","Updating recent message cache state"),X.APPS.MESSAGES.messages.set(X.APPS.MESSAGES.messages.value.map(C=>C.id===a.id?{...C,timestamp:new Date().getTime(),lastMessage:s.content,unread:!1,deleted:!1}:C))})},he=s=>{if(H.EnableMessagePay&&!(!s&&s<=0)){if(s>((H==null?void 0:H.MaxTransferAmount)??Number.MAX_SAFE_INTEGER))return D("error","Amount is too high");F.PopUp.set({title:r("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:H.CurrencyFormat.replace("%s",s.toString())}),description:r("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:H.CurrencyFormat.replace("%s",s.toString()),name:a.name??x(a.number)}),buttons:[{title:r("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:r("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{k("Wallet",{action:"sendPayment",number:a.number,amount:s}).then(h=>{if(!h.success){D("error","Failed to send payment "+JSON.stringify(h)),setTimeout(()=>{F.PopUp.set({title:r("APPS.MESSAGES.PAYMENT_FAILED_POPUP.TITLE"),description:r("APPS.MESSAGES.PAYMENT_FAILED_POPUP.DESCRIPTION").format({error:h.reason}),buttons:[{title:r("APPS.MESSAGES.PAYMENT_FAILED_POPUP.CLOSE")}]})},500);return}let C={id:a.id,sender:P,content:`<!SENT-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};p(y=>[...y,C])})}}]})}},Oe=s=>{if(!H.EnableMessagePay||!s&&s<=0)return;let h={sender:P,content:`<!REQUESTED-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};k("Messages",{action:"sendMessage",number:a.number,content:h.content,attachments:[]}).then(C=>{p(C?y=>[...y,{...h,id:C.messageId}]:y=>[...y,{...h,delivered:!1}])})},Ee=()=>{F.PopUp.set({title:r("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:r("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:r("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:r("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{k("Maps",{action:"getCurrentLocation"}).then(s=>{if(!s)return;let h={id:a.id,sender:P,content:`<!SENT-LOCATION-X=${Me(s.x,2)}Y=${Me(s.y,2)}!>`,attachments:[],timestamp:Date.now()};k("Messages",{action:"sendMessage",number:a.number,content:h.content,attachments:h.attachments,id:h.id}).then(C=>{p(C?y=>[...y,{...h,id:C.messageId}]:y=>[...y,{...h,delivered:!1}])})})}}]})},De=()=>{if(f||_)return;let s=document.querySelector("#last");if(!s)return;!Ye(s)&&(M(!0),k("Messages",{action:"getMessages",page:J+1,id:a.id}).then(C=>{if(C&&C.length>0){let y=document.querySelector(".message-container");ue.current=y.scrollHeight,p([...C.reverse(),...v]),M(!1)}else G(!0)}),B(C=>C+1))};m.useEffect(()=>{let s=document.querySelector(".message-container");const h=s.scrollHeight;s.scrollTop+=h-ue.current,s.scroll},[v]),ne("messages:newMessage",s=>{if(a.id===s.channelId){if(T.airplaneMode)return D("warning","Cannot receive message, airplane mode enabled");p(h=>[...h,{...s,timestamp:Date.now()}])}}),ne("messages:renameGroup",s=>{a.id===s.channelId&&(T.airplaneMode||i(h=>({...h,name:s.name})))}),ne("messages:messageDeleted",s=>{if(D("info","messages:messageDeleted triggered",s),!s)return D("error","Did not get any data from messages:messageDeleted, returning");if(T.airplaneMode)return D("warning","Cannot update message state, airplane mode enabled");p(h=>h.filter(C=>C.id!==s.messageId))}),ne("messages:removeMember",s=>{a.id===s.channelId&&(T.airplaneMode||s.number===P&&(u("userlist"),i(null)))});const Ue=be(s=>{if(!H.DeleteMessages)return D("error","Config.DeleteMessages is set to false");let h=s.target;for(;!h.classList.contains("message");)h=h.parentElement;let C=parseInt(h.getAttribute("data-id"));if(!C)return D("error","Failed to get message id when longpressing");let y=v.find(Q=>Q.id===C);if(!y)return D("error","Failed to find message with id",C);y.sender===P&&(fe(y.content)||Le(y.content)||ge(y.content)||F.ContextMenu.set({buttons:[{title:r("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{k("Messages",{action:"deleteMessage",channel:a.id,id:C}).then(Q=>{if(!Q)return D("error","Failed to delete message")})}}]}))}),Le=s=>!s||!H.EnableMessagePay?!1:/<!SENT-PAYMENT-(\d*)!>/.test(s)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(s),fe=s=>{if(s)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(s)},ge=s=>{if(s)return s==="<!CALL-NO-ANSWER!>"},ye=s=>{if(s)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(s)},ke=s=>{if(s.length===0)return!0;if(s)return!/^<!.*!>$/.test(s)};return e(ie,{children:c("div",{className:"animation-slide left",children:[c(me,{children:[A&&e(St,{setShow:w,setShowUserInfo:I,sendLocation:Ee,setData:i,data:a}),S&&e(ut,{setShow:I,user:a!=null&&a.isGroup?S:a})]}),c("div",{className:"message-header",children:[c("div",{className:"back",onClick:()=>{u("userlist"),i(null),a.unread&&(k("Messages",{action:"markRead",id:a.id}),o(s=>s-1))},children:[e(qe,{}),N>0&&e("span",{className:"back-title",children:N})]}),c("div",{className:"user",onClick:()=>{a.isGroup?w(!0):I(!0)},children:[a.isGroup?c("div",{className:"group-avatar",children:[a.members.sort((s,h)=>s.avatar?1:-1).map((s,h)=>e("img",{src:s.avatar??"./assets/img/no-pfp.png",alt:""},h)).slice(0,5),a.members.length===0&&e("img",{src:"./assets/img/no-pfp.png",alt:""})]}):e("img",{src:a.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:a.isGroup?a.name??`${a.members.length===0?1:a.members.length} ${r("APPS.MESSAGES.PEOPLE")}`:a.name??x(a.number)})]}),e(We,{className:`facetime ${a.isGroup?"hidden":""}`,onClick:()=>{a.isGroup||Fe({number:a.number,videoCall:!0})}})]}),e("div",{className:"message-container",onScroll:De,style:$||U?{height:"48%"}:{},children:e("div",{className:"message-body",children:v.map((s,h)=>e(ct,{index:h,messages:v,message:s,longPressEvent:Ue,func:{isMissed:ge,isLocation:fe,isVoiceMessage:ye,pay:he}}))})}),e("div",{className:"attachments",children:j.attachments.map((s,h)=>c("div",{className:"attachment",children:[Ce(s)?e("video",{src:s,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e("img",{src:s}),e(de,{onClick:()=>{se({...j,attachments:j.attachments.filter((C,y)=>y!==h)})}})]},h))}),c("div",{className:"message-bottom",style:$||U?{height:"18%"}:{},children:[e("div",{className:"upper",children:c("div",{className:"input","data-border":!g,children:[g?c("div",{className:"audio-message",children:[e(de,{onClick:()=>L(null)}),e("div",{className:"audio-waves",children:e("img",{src:g.waves.placeholder})})]}):e(re,{placeholder:r("APPS.MESSAGES.PLACEHOLDER"),ref:te,value:j.content,onChange:s=>{se({content:s.target.value,attachments:j.attachments})},onKeyDown:s=>{s.key=="Enter"&&Se()}}),(j.content.length>0||j.attachments.length>0||g)&&e("div",{className:"send",onClick:Se,children:e(Ge,{})})]})}),e("div",{className:"actions-wrapper",children:c("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(d)return F.Emoji.reset();F.Emoji.set({onSelect:s=>se(h=>({content:`${h.content}${s.emoji}`,attachments:h.attachments}))})},children:e("img",{src:"./assets/img/icons/messages/emoji.png"})}),e("div",{className:"action",onClick:()=>{var s,h,C;j.attachments.length<3&&F.Gallery.set({includeVideos:!0,allowExternal:(C=(h=(s=Z)==null?void 0:s.value)==null?void 0:h.AllowExternal)==null?void 0:C.Messages,onSelect:y=>se({...j,attachments:[...j.attachments,y.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),(H==null?void 0:H.EnableMessagePay)&&!a.isGroup&&e("div",{className:"action black",onClick:()=>{V(!1),Y(s=>!s)},children:"$"}),e("div",{className:"action",onClick:()=>Ee(),children:e(ze,{})}),(H==null?void 0:H.EnableVoiceMessages)&&e("div",{className:"action blue",onClick:()=>{Y(!1),V(s=>!s)},children:e(we,{})})]})}),$&&e(dt,{paymentAmount:O,setPaymentAmount:b,pay:he,request:Oe}),U&&e(ot,{onEnd:s=>{s&&(L({src:URL.createObjectURL(s.blob),blob:s.blob,waves:s.waveform,duration:s.duration}),V(!1))}})]})]})})}const ct=({messages:t,message:n,index:E,longPressEvent:T,func:P})=>{var $,Y;const{User:a}=m.useContext(ee),i=R(q.PhoneNumber),[l]=a,u=R(Z);let N,o,d,A,w,S,I=E===0?"last":"",U=n.sender===i?"self":"other",V=(($=t[E+1])==null?void 0:$.sender)===i?"self":"other";if(t[E+1]?d=Math.abs(n.timestamp-t[E+1].timestamp)/36e5:V=void 0,l.isGroup)N=(Y=l.members.find(O=>O.number===n.sender))==null?void 0:Y.name,o=!t[E-1]||t[E-1].sender!==n.sender;else if(N=l.name,n.content)if(P.isMissed(n.content))if(U==="other")n.content=r("APPS.MESSAGES.MISSED_CALL").format({number:n.sender});else return null;else/<!SENT-PAYMENT-(\d*)!>/.test(n.content)?A={amount:n.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(n.content)&&(A={amount:n.content.match(/\d/g).join(""),request:!0});if(P.isLocation(n.content)){let O=n.content.match(/X=(-?\d*\.?\d*)Y/)[1],b=n.content.match(/Y=(-?\d*\.?\d*)!>/)[1];w={x:O,y:b}}return P.isVoiceMessage(n.content)&&(S={wave:n.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:n.content.match(/AUDIO="([^"]+)"/)[1],duration:n.content.match(/DURATION="([^"]+)"/)[1]}),c("div",{className:`message ${U}`,id:I,"data-id":n.id,...T,children:[o&&U=="other"&&e("div",{className:"user",children:N??x(n.sender)}),n.delivered===!1?c("div",{className:"content-wrapper",children:[A&&e("div",{className:"payment",children:u.CurrencyFormat.replace("%s",A.amount)}),!A&&e("div",{className:"content",children:Ae(n.content)}),e(Qe,{})]}):A||w||S?c(ie,{children:[w&&c("div",{className:"location",onClick:()=>{F.ContextMenu.set({buttons:[{title:r("APPS.MESSAGES.OPEN_IN_MAPS"),cb:()=>{q.App.set({name:"Maps",data:{location:[w.y,w.x],name:`${N??x(n.sender)}'s location`,icon:l.avatar}})}},{title:r("APPS.MAPS.SET_WAYPOINT"),cb:()=>{k("Maps",{action:"setWaypoint",data:{x:w.x,y:w.y}})}}]})},children:[e("div",{className:"img",style:{backgroundImage:'url("https://img.gta5-mods.com/q95/images/mirror-park-garden/2b72f9-20160428154103_1.jpg")'}}),U==="other"&&c("div",{className:"sender",children:[N??x(n.sender)," ",r("APPS.MESSAGES.SENT_LOCATION")]})]}),A&&e("div",{className:"payment",children:A.request?c("div",{className:`request ${U}`,children:[c("div",{className:"title",children:[u.CurrencyFormat.replace("%s",ve(A.amount))," ",r("APPS.MESSAGES.PAY.REQUESTED")]}),U==="other"&&e("div",{className:"button",onClick:()=>P.pay(A.amount),children:r("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:u.CurrencyFormat.replace("%s",ve(A.amount))})}),S&&e(mt,{data:S,sender:U})]}):n.content&&e("div",{className:"content",children:Ae(n.content)}),n.attachments&&n.attachments.length>0&&e("div",{className:"attatchments",children:n.attachments.map((O,b)=>Ce(O)?e("video",{src:O,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:J=>F.FullscreenImage.set({display:!0,image:O})},b):e(je,{src:O,onClick:()=>F.FullscreenImage.set({display:!0,image:O})},b))}),n.delivered===!1?e("div",{className:"status",children:r("APPS.MESSAGES.NOT_DELIVERED")}):t[E+1]&&d>6?e("div",{className:"date",children:Ne(n.timestamp)}):U!==V&&e("div",{className:"date",children:Ne(n.timestamp)})]},E)},ot=({onEnd:t})=>{const n=R(Z),[E,T]=m.useState(!1),P=m.useRef(null);return n.EnableVoiceMessages?(m.useEffect(()=>{P.current=new it},[]),e("div",{className:"audioMessage-container",children:e("div",{className:"audioMessage-button","data-recording":E,onClick:()=>{var i;if(!((i=navigator.mediaDevices)!=null&&i.getUserMedia)||!(P!=null&&P.current))return D("error","No media devices found!");let a=P.current;E?a.stop().then(l=>{t(l),T(u=>!u)}):(a.start(),T(l=>!l))},children:E?e(de,{}):e(we,{})})})):null},dt=({paymentAmount:t,setPaymentAmount:n,request:E,pay:T})=>{const P=R(Z),[a,i]=m.useState(0),[l,u]=m.useState(4);let N={0:3,11:2.75,14:2.2};return m.useEffect(()=>{a===0&&u(N[0]);let o=0;for(let d=0;d<Object.keys(N).length;d++)a>=parseInt(Object.keys(N)[d])&&(o=N[Object.keys(N)[d]]);u(o)},[a]),m.useEffect(()=>{n(a)},[a]),c("div",{className:"payment-container",children:[c("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&i(o=>o-1),children:"-"}),e("div",{className:"amount",children:e(re,{type:"number",value:t,style:{fontSize:`${l}rem`},onChange:o=>{if(o.target.value.match(/^[0-9]+$/)&&parseFloat(o.target.value)>0&&parseFloat(o.target.value)<(P.MaxTransferAmount??Number.MAX_SAFE_INTEGER))i(parseFloat(o.target.value));else return o.preventDefault()}})}),e("div",{className:"button",onClick:()=>i(o=>o+1),children:"+"})]}),c("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>E(t),children:r("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>T(t),children:r("APPS.MESSAGES.PAY.SEND")})]})]})},mt=({data:t,sender:n})=>{var u;const[E,T]=m.useState(!1),[P,a]=m.useState(0),i=m.useRef(null);m.useEffect(()=>{i.current&&(i.current.onended=()=>{T(!1)})},[i]);const l=N=>{N=Math.floor(N);const o=Math.floor(N/60),d=N-o*60;return`${o<10?"0"+o:o}:${d<10?"0"+d:d}`};return c("div",{className:`voice-message ${n}`,children:[e("a",{onClick:()=>{i.current&&(E?(i.current.pause(),i.current.currentTime=0):i.current.play(),T(N=>!N))},children:E?e(Ke,{}):e(Je,{})}),c("div",{className:"wave",children:[e("div",{className:"overlay",style:{width:`${(t.duration-P)/t.duration*100}%`}}),e("img",{src:t.wave,alt:"wave"})]}),e("div",{className:"duration",children:l(E&&Math.floor(((u=i.current)==null?void 0:u.currentTime)+.5)!==0?i.current.currentTime:t.duration)}),e("audio",{ref:i,onTimeUpdate:N=>a(N.currentTarget.currentTime),children:e("source",{src:t.src,type:"audio/mpeg"})})]})},ut=({user:t,setShow:n})=>c(ce.div,{...le,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>n(!1),children:r("APPS.MESSAGES.DONE")})}),c("div",{className:"info-panel-body",children:[c("div",{className:"info-panel-top",children:[t.avatar?e("div",{className:"profile-image bigger",style:{backgroundImage:`url(${t.avatar})`}}):t.name?e("div",{className:"profile-image bigger",children:xe(t.name)}):e("img",{src:t.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:t.name??x(t.number)})]}),e("div",{className:"items",children:!t.company&&c(ie,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>He(t.number),children:x(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{F.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:r("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{q.App.set({name:"Phone",view:"newContact",data:t.number})},children:r("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]}),St=t=>{const{View:n}=m.useContext(ee),[E,T]=n,[P,a]=m.useState(!1),[i,l]=m.useState(null);let u=t.data,N=!u.members.find(o=>o.isOwner);return c(ie,{children:[e(me,{children:P&&e(ht,{setShow:a,members:u.members,id:u.id})}),c(ce.div,{...le,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>{i&&i!==""&&i!==u.name?k("Messages",{action:"renameGroup",id:u.id,name:i}).then(o=>{t.setShow(!1)}):t.setShow(!1)},children:r("APPS.MESSAGES.DONE")})}),c("div",{className:"info-panel-body",children:[c("div",{className:"info-panel-top",children:[c("div",{className:"group-avatar",children:[u.members.sort((o,d)=>o.avatar?1:-1).slice(0,10).map((o,d)=>e("img",{src:o.avatar??"./assets/img/no-pfp.png",alt:""},d)),u.members.length===0&&e("img",{src:"./assets/img/no-pfp.png",alt:""})]}),c("div",{className:"members",children:[u.members.length===0?1:u.members.length," ",r("APPS.MESSAGES.MEMBERS")]})]}),c("div",{className:"items",children:[e("div",{className:"info-section",children:c("div",{className:"item blue",children:[e(Ze,{className:"add"}),e(re,{defaultValue:u.name??"Group Name",onChange:o=>l(o.target.value)})]})}),c("div",{className:"info-section",children:[u.members.sort((o,d)=>o.name&&!d.name?-1:!o.name&&d.name?1:o.name<d.name?-1:o.name>d.name?1:0).map((o,d)=>c("div",{className:"item",children:[N&&e(et,{className:"remove",onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:r("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:o.name??x(o.number)}),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{k("Messages",{action:"removeMember",number:o.number,id:u.id}).then(A=>{A&&(t.setData(w=>{let S=w;return S.members=S.members.filter(I=>I.number!==o.number),S}),t.setShow(!1))})}}]})}}),e("img",{src:o.avatar??"./assets/img/no-pfp.png",alt:""}),e("div",{className:"name",children:o.name??x(o.number)}),e(tt,{className:"info",onClick:()=>{t.setShowUserInfo({...o})}})]},d)),c("div",{className:"item blue",onClick:()=>a(!0),children:[e(st,{className:"add"}),r("APPS.MESSAGES.ADD_MEMBER")]})]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:r("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:r("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{k("Messages",{action:"leaveGroup",id:u.id}).then(o=>{if(!o)return D("info","Failed to leave group, server didnt callback request");T("userlist"),t.setShow(!1)})}}]})},children:e("div",{className:"item red",children:r("APPS.MESSAGES.LEAVE_GROUP")})})]})]})]})]})},ht=t=>{const n=R(q.PhoneNumber),[E,T]=m.useState(""),P=R(X.APPS.PHONE.contacts);let a=t.members;return c(ce.div,{...le,className:"add-member-container",children:[c("div",{className:"add-member-header",children:[c("div",{className:"top",children:[e("span",{}),e("div",{className:"title",children:r("APPS.MESSAGES.ADD_MEMBER")}),e("div",{className:"button",onClick:()=>t.setShow(!1),children:r("APPS.MESSAGES.CANCEL")})]}),e(Te,{placeholder:r("APPS.MESSAGES.SEARCH"),onChange:i=>T(i.target.value)})]}),e("div",{className:"contacts",children:P.filter(i=>!i.company).sort((i,l)=>i.firstname&&!l.firstname?-1:!i.firstname&&l.firstname?1:i.firstname<l.firstname?-1:i.firstname>l.firstname?1:0).filter(i=>!a.find(l=>l.number===i.number)||i.number===n).filter(i=>{var l,u;return i.firstname.toLowerCase().includes(E.toLowerCase())||((u=(l=i==null?void 0:i.lastname)==null?void 0:l.toLowerCase())==null?void 0:u.includes(E.toLowerCase()))}).map((i,l)=>{let u=K(i.firstname,i.lastname);return c("div",{className:"contact",onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.ADD_POPUP.TITLE"),description:r("APPS.MESSAGES.ADD_POPUP.TEXT").format({name:u}),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.ADD_POPUP.ADD"),cb:()=>{k("Messages",{action:"addMember",number:i.number,id:t.id}).then(N=>{N&&t.setShow(!1)})}}]})},children:[e("img",{src:i.avatar??"./assets/img/no-pfp.png"}),c("div",{className:"user",children:[e("div",{className:"name",children:u}),e("div",{className:"number",children:x(i.number)})]})]},l)})})]})};function Et(){const{User:t,View:n,Newmessage:E,ImportedUser:T}=m.useContext(ee),[P,a]=t,[i,l]=n,[u,N]=T,o=R(q.PhoneNumber),[d,A]=E,w=R(X.APPS.PHONE.contacts),[S,I]=m.useState([]),U=m.useRef(null),[V,$]=m.useState(""),[Y,O]=m.useState([]),[b,J]=m.useState({content:"",attachments:[]});m.useEffect(()=>{u&&(I([u]),N(null))},[u]);const B=()=>{(b.content.length>0||b.attachments.length>0)&&(S.length>1?k("Messages",{action:"createGroup",members:S,content:b.content,attachments:b.attachments}).then(f=>{if(!f)return D("error","Failed to create group");a({isGroup:!0,members:S.map(G=>{let _=K(G.firstname,G.lastname);return{...G,name:_}}),lastMessage:b.content,timestamp:Date.now(),id:f.channelId}),l("messages"),A(!1)}):k("Messages",{action:"sendMessage",number:S[0].number,content:b.content,attachments:b.attachments}).then(f=>{var M,v,p,g;if(!f)return D("error","Failed to send message");let G;S[0].name?G=S[0].name:(M=S[0])!=null&&M.firstname&&(G=K((v=S[0])==null?void 0:v.firstname,(p=S[0])==null?void 0:p.lastname));let _={number:S[0].number,name:G,avatar:(g=S[0])==null?void 0:g.avatar};a({..._,lastMessage:b.content,timestamp:Date.now(),id:f.channelId}),l("messages"),A(!1)}))};return m.useEffect(()=>{if(V.length>0){if(w){const f=w.filter(G=>{let _=K(G.firstname,G.lastname);return _&&_.toLowerCase().includes(V.toLowerCase())&&!G.company});O(f)}}else O([])},[V]),c(ce.div,{...le,className:"new-message-container",children:[c("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:r("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{S.length>0&&(b.content.length>0||b.attachments.length>0)?B():A(!1)},children:S.length>0&&(b.content.length>0||b.attachments.length>0)?r("APPS.MESSAGES.SEND"):r("APPS.MESSAGES.CANCEL")})]}),c("div",{className:"new-message-body",children:[c("div",{className:"new-message-search",children:[c("div",{className:"to",children:[r("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:S.map((f,G)=>{let _=K(f.firstname,f.lastname),M=_!=="Unknown";return e("div",{className:`contact ${M?"green":"blue"}`,onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:r("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:_??x(f.number)}),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let v=S.filter(p=>p.number!==f.number);I(v)}}]})},children:M?_:x(f.number)},G)})}),e(re,{type:"text",ref:U,onChange:f=>{if($(f.target.value),f.target.value.length==o.length&&/^\d+$/g.test(f.target.value)){if(f.target.value===o||S.find(_=>_.number==f.target.value))return;I([...S,{number:f.target.value}]),U.current.value="",$("")}},onKeyDown:f=>{var G;f.key=="Backspace"&&V.length==0?((G=S[S.length-1])==null?void 0:G.name)===void 0?(U.current.value=S[S.length-1].number,I(S.slice(0,S.length-1))):I(S.slice(0,-1)):f.key=="Tab"&&(f.preventDefault(),Y.length==1&&(I([...S,Y[0]]),U.current.value="",$("")))}})]}),e("div",{className:"search-results",children:Y&&Y.filter(f=>!S.find(G=>G.number==f.number)).map((f,G)=>{let _=K(f.firstname,f.lastname);return c("div",{className:"contact",onClick:()=>{S.find(v=>v.number==f.number)||(I([...S,f]),U.current.value="",$(""))},children:[e("img",{src:f.avatar??"./assets/img/no-pfp.png"}),c("div",{className:"user",children:[e("div",{className:"name",children:_}),e("div",{className:"number",children:x(f.number)})]})]},G)})})]}),S.length>0&&Y.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:c("div",{className:"input",children:[e(re,{placeholder:r("APPS.MESSAGES.PLACEHOLDER"),value:b.content,onChange:f=>{J({content:f.target.value??"",attachments:b.attachments})},onKeyDown:f=>{f.key=="Enter"&&B()}}),(b.content.length>0||b.attachments.length>0)&&e("div",{className:"send",onClick:()=>B(),children:e(Ge,{})})]})})})]})}const z=Ie([]),W=Ie([]);function ft(){const{User:t,View:n,Newmessage:E,UnreadMessages:T,ImportedUser:P}=m.useContext(ee),a=R(q.PhoneNumber),i=R(q.Settings),l=R(q.App),[u,N]=t,[o,d]=n,[A,w]=P,[S,I]=E,[U,V]=T,$=R(X.APPS.PHONE.contacts),Y=R(X.APPS.MESSAGES.messages),O=R(z),[b,J]=m.useState(""),[B,f]=m.useState(!1),G=R(W);m.useEffect(()=>{Y?(D("info","Using cache for recent messages"),z.set(Y),V(O.filter(M=>M.unread).length)):k("Messages",{action:"getRecentMessages"}).then(M=>{let v=M.map(p=>{if(p.isGroup)return p.members=p.members.filter(g=>g.number!==a).map(g=>{let L=$.find(te=>te.number===g.number);return{name:L&&L.firstname?K(L==null?void 0:L.firstname,L==null?void 0:L.lastname):void 0,avatar:L==null?void 0:L.avatar,blocked:L==null?void 0:L.blocked,favourite:L==null?void 0:L.favourite,number:g.number,isOwner:g.isOwner}}),p;{let g=$.find(L=>L.number===p.number);return p.name=g!=null&&g.lastname?`${g.firstname} ${g.lastname}`:g==null?void 0:g.firstname,p.avatar=g==null?void 0:g.avatar,p}});V(v.filter(p=>p.unread).length),z.set(v),D("info","setting cache"),X.APPS.MESSAGES.messages.set(v)})},[Y]);let _=m.useRef(!1);return m.useEffect(()=>{if(!_.current&&l!=null&&l.data&&(_.current=!0,l!=null&&l.data&&l.view=="messages")){let M=O.find(v=>v.number===l.data.number);M?(N(M),d("messages")):(I(!0),w({number:l.data.number,name:l.data.name,avatar:l.data.avatar})),q.App.set({name:l.name})}},[l==null?void 0:l.data,O]),ne("messages:newMessage",M=>{let v=JSON.parse(JSON.stringify(O)),p=v.findIndex(g=>g.id===M.channelId);i.airplaneMode||(p!==-1&&v.unshift(v.splice(p,1)[0]),v[0].lastMessage=M.content,v[0].timestamp=new Date,z.set(v))}),c(ie,{children:[e(me,{children:S&&e(Et,{})}),c("div",{className:`animation-slide ${O.length>0?"right":""}`,children:[c("div",{className:"messages-header",children:[c("div",{className:"buttons",children:[e("div",{className:"edit",onClick:()=>f(!B),children:B?r("APPS.MESSAGES.DONE"):r("APPS.MESSAGES.EDIT")}),e(at,{"data-disabled":B,onClick:()=>I(!0)})]}),e("div",{className:"title",children:r("APPS.MESSAGES.TITLE")})]}),e(Te,{placeholder:r("SEARCH"),onChange:M=>J(M.target.value)}),e("div",{className:"users-list",children:O.filter(M=>{var v;return M.deleted?!1:(M.isGroup?M.members.find(p=>{var g;return((g=p.name)==null?void 0:g.toLowerCase().includes(b.toLowerCase()))||p.number.includes(b)}):((v=M.name)==null?void 0:v.toLowerCase().includes(b.toLowerCase()))||M.number.includes(b))||M.lastMessage.toLowerCase().includes(b.toLowerCase())}).sort((M,v)=>v.timestamp-M.timestamp).map((M,v)=>e(gt,{user:M,editMode:B,onClick:()=>{if(N(M),d("messages"),M.unread){k("Messages",{action:"markRead",id:M.id}),V(g=>g-1);let p=X.APPS.MESSAGES.messages.value;X.APPS.MESSAGES.messages.set(p.map(g=>(g.id===M.id&&(g.unread=!1),g)))}}},v))}),B&&c("div",{className:"messages-footer",children:[e("div",{className:"button","data-disabled":!0,children:r("APPS.MESSAGES.READ")}),e("div",{className:"button",onClick:()=>{if(G.length===0)return D("info","No messages selected, can't delete");F.PopUp.set({title:r("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:r("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.DELETE"),cb:()=>{k("Messages",{action:"deleteConversations",channels:G}).then(M=>{if(!M)return D("error","Failed to delete conversations");f(!1),z.set(O.filter(v=>!G.includes(v.id))),X.APPS.MESSAGES.messages.set([...X.APPS.MESSAGES.messages.value.map(v=>(G.includes(v.id)&&(v.deleted=!0),v))]),W.set([])})}}]})},children:r("APPS.MESSAGES.DELETE")})]})]})]})}const gt=({user:t,editMode:n,onClick:E})=>{var N,o;const T=R(Z),P=R(z);R(W);const[a,i]=m.useState(!1);let l;const u=be(d=>{F.ContextMenu.set({buttons:[{title:r("APPS.MESSAGES.MARK_AS_READ"),cb:()=>{k("Messages",{action:"markRead",id:t.id}).then(A=>{if(!A)return D("error","Failed to mark message as read");z.set(P.map(S=>(S.id===t.id&&(S.unread=!1),S)));let w=X.APPS.MESSAGES.messages.value;X.APPS.MESSAGES.messages.set(w.map(S=>(S.id===t.id&&(S.unread=!1),S)))})}},{title:r("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),color:"red",cb:()=>{F.PopUp.set({title:r("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:r("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.DELETE"),cb:()=>{k("Messages",{action:"deleteConversations",channels:[t.id]}).then(A=>{if(!A)return D("error","Failed to delete conversations");z.set(P.filter(w=>w.id!==t.id)),X.APPS.MESSAGES.messages.set([...X.APPS.MESSAGES.messages.value.map(w=>(w.id===t.id&&(w.deleted=!0),w))]),W.set([])})}}]})}}]})});if(t.isGroup?t.name?l=t.name:t.members.length===0?l=r("APPS.MESSAGES.GROUP"):l=t.members.sort((d,A)=>d.name&&!A.name?-1:!d.name&&A.name?1:d.name<A.name?-1:d.name>A.name?1:0).map((d,A)=>{if(A<2)return d.name?d.name:x(d.number);if(A===2)return`+${t.members.length-2} ${r("APPS.MESSAGES.OTHER").toLowerCase()}`}).join(", "):l=t.name,t.lastMessage){if(t.lastMessage==="Attachment"&&(t.lastMessage=r("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let d=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${r("APPS.MESSAGES.SENT")} ${T.CurrencyFormat.replace("%s",d)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let d=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${r("APPS.MESSAGES.REQUESTED")} $${d}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${r("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage=r("APPS.MESSAGES.SENT_AUDIO_MESSAGE");else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=r("APPS.MESSAGES.TRIED_TO_CALL").format({number:x(t.number)});else if(t.lastMessage==="")return}return m.useEffect(()=>{a?W.set([...W.value,t.id]):W.set(W.value.filter(d=>d!==t.id))},[a]),c("div",{className:"user",...u,onClick:()=>{n?i(!a):E()},children:[c("div",{className:"items",children:[n&&e("div",{className:"check","data-checked":a,onClick:d=>{d.stopPropagation(),i(!a)},children:a&&e(nt,{})}),e("div",{className:Xe("dot",t.unread&&"unread")})]}),t.isGroup?c("div",{className:"avatar group",children:[t.members.map((d,A)=>{if(A<=3)return d.avatar?e("div",{style:{backgroundImage:`url(${d.avatar})`}},A):d.name?e("div",{children:d.name.charAt(0)},A):e("div",{className:"unknown"},A)}),t.members.length===0&&e("img",{className:"avatar",src:"assets/img/no-pfp.png"})]}):e("img",{className:"avatar",src:t.avatar??"assets/img/no-pfp.png"}),c("div",{className:"user-body",children:[c("div",{className:"user-header",children:[e("div",{className:"name",children:l??x(t.number)}),c("div",{className:"right",children:[e("div",{className:"time",children:Be(t.timestamp)}),e(rt,{})]})]}),e("div",{className:"content",children:((N=t.lastMessage)==null?void 0:N.length)>40?((o=t.lastMessage)==null?void 0:o.substring(0,40))+"...":t.lastMessage})]})]})};const ee=m.createContext(null);function pt(){const[t,n]=m.useState(null),[E,T]=m.useState("userlist"),[P,a]=m.useState(null),[i,l]=m.useState(0),[u,N]=m.useState(!1);return e("div",{className:"messages-container",children:e(ee.Provider,{value:{User:[t,n],View:[E,T],Newmessage:[u,N],ImportedUser:[P,a],UnreadMessages:[i,l]},children:E=="userlist"?e(ft,{}):e(lt,{})})})}export{ee as MessagesContext,pt as default};
