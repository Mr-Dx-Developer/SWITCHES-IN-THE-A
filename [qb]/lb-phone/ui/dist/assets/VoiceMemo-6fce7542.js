import{r as s,a as m,j as a,F as L}from"./jsx-runtime-f40812bf.js";import{w as R,o as g,f as T,x as k,C as w,L as P,X as _,Y as U,Z as $,A as F,d as p,p as H,I as y,E as D,b as B}from"./Phone-cc49d184.js";import{r as j}from"./number-28525126.js";import{u as V,s as K,A as W,m as G,ay as J,J as X,K as Y,c as Z,L as q,ae as z}from"./index.esm-497ba86e.js";const x=K(null);function ie(){const h=s.useRef(null),[o,M]=s.useState(""),[O,i]=s.useState(!1),c=V(g.APPS.VOICEMEMO.voicememos);s.useEffect(()=>(R("VoiceMemo").then(t=>{t&&(h.current=t)}),g.APPS.DARKCHAT.channels.value||T("VoiceMemo",{action:"get"}).then(t=>{g.APPS.VOICEMEMO.voicememos.set(t)}),()=>{h.current&&k("VoiceMemo")}),[]);const N=()=>{let t=P("APPS.VOICEMEMO.DEFAULT_NAME"),n=c.map(r=>{let l=r.title;if(l.startsWith(t)){let d=l.split(" ");if(d.length>1&&/^\d+$/.test(d[d.length-1]))return parseInt(d[d.length-1])}return null}).filter(r=>r!==null).sort((r,l)=>r-l);if(n.length===0)return c.some(r=>r.title===t)?`${t} 2`:t;for(let r=0;r<n.length;r++)if(n[r]!==r+2)return`${t} ${r+2}`;return`${t} ${n[n.length-1]+1}`};return s.useEffect(()=>{if(!O)return;if(!h.current)return w.PopUp.set({title:P("APPS.VOICEMEMO.NO_MICROPHONE_POPUP.TITLE"),description:P("APPS.VOICEMEMO.NO_MICROPHONE_POPUP.DESCRIPTION"),buttons:[{title:P("APPS.VOICEMEMO.NO_MICROPHONE_POPUP.OK")}]}),i(!1);const t=new AudioContext,n=new MediaStreamAudioDestinationNode(t);t.createMediaStreamSource(h.current).connect(n),_("VoiceMemo",t,n);const l=new MediaRecorder(n.stream);let d=[],I=Date.now();return l.ondataavailable=C=>{d.push(C.data)},l.onstop=async()=>{let C=Date.now()-I,b=Math.round(C/1e3);const A=new Blob(d,{type:l.mimeType});U("VoiceMemo"),t.close();const u=await $(A,C,{logger:!1});F("Audio",u).then(E=>{p("info","Uploaded media");let S=N();T("VoiceMemo",{action:"upload",data:{src:E,duration:b,title:S}}).then(e=>{if(!e)return p("warning","Failed to upload voice memo");g.APPS.VOICEMEMO.voicememos.set([{id:e,title:S,timestamp:new Date().getTime(),duration:b,src:E},...c]),p("info",`Saved voice memo ${e}`)})}).catch(E=>{p("error","Failed to upload ",E)})},l.start(),()=>{l.stop()}},[O]),m("div",{className:"voicememo-container",children:[m("div",{className:"voicememo-wrapper",children:[a("div",{className:"title",children:P("APPS.VOICEMEMO.ALL_RECORDINGS")}),a(H,{placeholder:P("SEARCH"),theme:"dark",onChange:t=>M(t.target.value)}),a("div",{className:"voicememo-items",children:c.filter(t=>t.title.toLowerCase().includes(o.toLowerCase())).sort((t,n)=>n.timestamp-t.timestamp).map(t=>a(Q,{data:t,delete:()=>g.APPS.VOICEMEMO.voicememos.set(c.filter(n=>n.id!==t.id))},t.id))})]}),a("div",{className:"voicememo-footer",children:a("div",{className:"button-record",onClick:()=>i(!O),children:a("div",{className:"button-inner","data-recording":O})})})]})}const Q=h=>{const{data:o}=h,M=V(B.Settings),O=V(g.APPS.VOICEMEMO.voicememos),i=s.useRef(null),[c,N]=s.useState(!1),[t,n]=s.useState(!1),[r,l]=s.useState(0),d=V(x),[I,C]=s.useState(o.title),[b,A]=s.useState(!1),[u,E]=s.useState(null);s.useEffect(()=>(i.current=new Audio(o.src),i.current.src=o.src,i.current.volume=M.sound.volume??.5,i.current.addEventListener("ended",()=>{n(!1)}),i.current.addEventListener("timeupdate",()=>{l(i.current.currentTime)}),()=>{var e,f;(e=i.current)==null||e.pause(),(f=i.current)==null||f.remove(),i.current=null}),[]),s.useEffect(()=>{var e;d&&d!==o.id&&((e=i.current)==null||e.pause(),n(!1),N(!1))},[d]),s.useEffect(()=>{M.sound.volume&&(i.current.volume=M.sound.volume)},[M.sound.volume]),s.useEffect(()=>{n(!1),l(0),c&&x.set(o.id)},[c]);const S=e=>{const f=Math.floor(e/60),v=j(e-f*60,0);return`${f}:${v<10?"0"+v:v}`};return m("div",{className:"voicememo-item",onClick:()=>N(!c),"data-expanded":c,children:[c?a(y,{className:"voicememo-title",defaultValue:I,onClick:e=>e.stopPropagation(),onLoad:e=>{e.target.style.width=e.target.value.length+"ch"},onChange:e=>{C(e.target.value),e.target.style.width=e.target.value.length+"ch"},onBlur:e=>{T("VoiceMemo",{action:"rename",id:o.id,title:e.target.value}).then(f=>{if(!f)return p("warning","Failed to rename voice memo");g.APPS.VOICEMEMO.voicememos.set(O.map(v=>v.id===o.id?{...v,title:e.target.value}:v))})}}):a("div",{className:"voicememo-title",children:I}),c&&a("div",{className:"subtitle",children:D(o.timestamp)}),m("div",{className:"voicememo-info",children:[!c&&m(L,{children:[a("div",{className:"date",children:D(o.timestamp)}),a("div",{className:"duration",children:S(o.duration)})]}),a(W,{children:c&&m(G.div,{className:"voicememo-actions",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},children:[m("div",{className:"voicememo-duration-slider",onClick:e=>e.stopPropagation(),children:[a(y,{type:"range",min:0,max:100,value:u||r/o.duration*100,style:{background:`linear-gradient(to right, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.7) ${u||r/o.duration*100}%, rgba(255, 255, 255, 0.1) ${u||r/o.duration*100}%, rgba(255, 255, 255, 0.1) 100%)`},onMouseDown:e=>{e.stopPropagation(),A(!0)},onMouseUp:e=>{if(e.stopPropagation(),A(!1),u){if(!i.current)return p("warning","Audio ref is null");i.current.currentTime=o.duration/100*u,E(null)}},onChange:e=>{e.stopPropagation(),E(e.target.value)}}),m("div",{className:"duration",children:[a("div",{children:S(r)??"0:00"}),a("div",{children:S(o.duration)})]})]}),m("div",{className:"voicememo-item-footer",children:[a("div",{className:"share",children:a(J,{onClick:e=>{e.stopPropagation(),w.Share.set({type:"voicememo",data:o})}})}),m("div",{className:"controls",children:[a(X,{className:"disabled"}),a("span",{onClick:e=>{if(e.stopPropagation(),!i.current)return p("warning","Audio ref is null");t?(i.current.pause(),n(!1)):(i.current.play(),n(!0))},children:t?a(Y,{}):a(Z,{})}),a(q,{className:"disabled"})]}),a("div",{className:"delete",children:a(z,{onClick:e=>{e.stopPropagation(),w.PopUp.set({title:P("APPS.VOICEMEMO.DELETE_POPUP.TITLE"),description:P("APPS.VOICEMEMO.DELETE_POPUP.DESCRIPTION"),buttons:[{title:P("APPS.VOICEMEMO.DELETE_POPUP.CANCEL")},{title:P("APPS.VOICEMEMO.DELETE_POPUP.PROCEED"),color:"red",cb:()=>{T("VoiceMemo",{action:"delete",id:o.id}).then(f=>{if(!f)return p("warning","Failed to delete voice memo");h.delete()})}}]})}})})]})]})})]})]})};export{ie as default};
