import{r as s,j as n,F as J,a as g}from"./jsx-runtime-f40812bf.js";import{s as fe,W as me,w as ge,x as he,f as c,u as pe,b as O,S as v,o as V,X as ve,d as f,Y as Se,Z as be,C as x,_ as Ce,L as ee,z as we,A as Pe,R as ye,h as Re}from"./Phone-cc49d184.js";import{u as w,O as Ae,P as Ie,Q as ke}from"./index.esm-497ba86e.js";import{r as te}from"./number-28525126.js";function Oe(){const m=w(Re),{Placement:ae}=s.useContext(fe),re=w(x.CameraComponent),P=w(v.Unlocked),j=w(v.PassedFaceId),y=w(v.Visible),se=w(v.LockScreenVisible),[Ne,R]=ae.PhoneRotation,[$,S]=s.useState(!1),[o,E]=s.useState("Photo"),[L,H]=s.useState(!1),[ne,X]=s.useState(!1),[W,M]=s.useState(null),[h,G]=s.useState(!1),[d,oe]=s.useState(!1),[Q,q]=s.useState(0),[ie,T]=s.useState({}),z=s.useRef(null),B=s.useRef(null),b=s.useRef(null),l=s.useRef(null),A=s.useRef(null),u=["Video","Photo","Landscape"];s.useEffect(()=>{if(!b.current||l.current)return;let e=new me(b.current);l.current=e},[b.current,y]),s.useEffect(()=>(ge("Camera").then(e=>{e&&(A.current=e)}),()=>{l.current&&l.current.destroy(),A.current&&he("Camera"),re||c("Camera",{action:"close"})}),[]),pe("camera:usedCommand",e=>{switch(e){case"toggleTaking":I();break;case"toggleFlip":G(t=>!t);break;case"toggleFlash":H(t=>!t);break;case"leftMode":if(d)return;E(t=>{const a=u.indexOf(t);return a===0?u[u.length-1]:u[a-1]});break;case"rightMode":if(d)return;E(t=>{const a=u.indexOf(t);return a===u.length-1?u[0]:u[a+1]});break}}),s.useEffect(()=>{if(!B.current)return;let e=[];const a=setInterval(()=>{e.length>2&&(e=[]),e.push("."),B.current.innerText=ee("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(a)},[$]);const F=(e,t)=>{if(t===void 0&&(t=we(e)),t){const a=document.createElement("video");a.src=e,a.muted=!0,a.play();const r=document.createElement("canvas");if(!r)return;a.addEventListener("loadeddata",()=>{r.width=a.videoWidth,r.height=a.videoHeight,r.getContext("2d").drawImage(a,0,0,r.width,r.height);const C=r.toDataURL("image/png");z.current.style.backgroundImage=`url(${C})`,V.APPS.CAMERA.lastImage.set(C),r.remove(),a.remove()})}else z.current.style.backgroundImage=`url(${e})`,V.APPS.CAMERA.lastImage.set(e)};s.useEffect(()=>{if(!y)return()=>{O.App.reset(),P||v.LockScreenVisible.set(!0)}},[y]),s.useEffect(()=>{if(c("Camera",{action:y?"open":"close"}),se||!P)v.Flashlight&&(c("toggleFlashlight",{toggled:!1}),v.Flashlight.set(!1)),R(0),E("Photo");else{if(c("Camera",{action:"flipCamera",value:h}),V.APPS.CAMERA.lastImage.value)return F(V.APPS.CAMERA.lastImage.value);c("Camera",{action:"getLastImage"}).then(e=>{e&&F(e)})}},[P,j,y]),s.useEffect(()=>{if(d)return;switch(o){case"Landscape":T({marginRight:"9rem"}),R(90);break;case"Video":R(0),T({marginLeft:"12rem"});break;default:R(0),T({marginLeft:"3rem"});break}o==="Landscape"?l.current&&l.current.resizeByAspect(16/9):(o==="Video"||o==="Photo")&&l.current&&l.current.resizeByAspect(3/4),c("Camera",{action:"toggleLandscape",toggled:o==="Landscape"}),c("Camera",{action:"toggleVideo",toggled:o==="Video"});const e=window.innerWidth;e>1920&&l.current.setQuality(1920/e),o==="Photo"&&h?l.current.setXOffset(-.2):l.current.setXOffset(0)},[o]),s.useEffect(()=>{c("Camera",{action:"flipCamera",value:h}),!d&&(o=="Photo"&&h?l.current.setXOffset(-.2):l.current.setXOffset(0))},[P,h]);const K=s.useRef(!0),Y=async(e,t)=>{const a=te(e.size/1e3,2);L&&c("toggleFlashlight",{toggled:!1});try{const r=await Pe(t?"Video":"Image",e);if(!r)throw new Error("Failed to upload media (URL is null)");return t?F(URL.createObjectURL(e),!0):F(r),f("info",`Saving ${t?"video":"photo"} to gallery (${a}kb) - ${r}, args(${r}, ${a}, ${h&&!t?"selfie":null})`),await ye(r,a,h&&!t?"selfie":null,!0),!0}catch(r){throw r}};s.useEffect(()=>{if(K.current){K.current=!1;return}if(L&&!d&&c("toggleFlashlight",{toggled:!1}),!d)return;const e=b.current.captureStream(m.videoOptions.fps),t=new AudioContext,a=new MediaStreamAudioDestinationNode(t);A.current?t.createMediaStreamSource(A.current).connect(a):t.createOscillator().connect(a),ve("Camera",t,a);const r=[e.getVideoTracks()[0]];(A.current||m.recordNearbyVoices)&&r.unshift(a.stream.getAudioTracks()[0]);const C=new MediaStream(r),p=new MediaRecorder(C,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:m.videoOptions.bitrate*8*1e3});let U=0;const le=p.audioBitsPerSecond+p.videoBitsPerSecond,Z=setInterval(()=>{const i=(Date.now()-U)/1e3,D=le*i/8/1024/1024,N=te(D,2);N>=m.videoOptions.size&&(f("info",`Video file size limit reached (${N}mb)`),clearInterval(Z),I())},100);let _=[];p.ondataavailable=i=>{var k;((k=i==null?void 0:i.data)==null?void 0:k.size)>0&&_.push(i.data)},p.onerror=i=>{f("error","error recording:",i)},p.onstop=async()=>{clearInterval(Z);let i=Date.now()-U,k=new Blob(_,{type:"video/webm"});t.close(),S(!0),Se("Camera");const D=await be(k,i,{logger:!1});try{await Y(D,!0),f("info","Video uploaded successfully"),S(!1)}catch(N){f("error","Could not upload video",N),S(!1),M(N.message),await new Promise(ue=>setTimeout(ue,1e4)),M(null)}},U=Date.now(),p.start();const de=setInterval(()=>{if(Q>=m.videoOptions.duration)return I();q(i=>i+1>=m.videoOptions.duration?(I(),0):i+1)},1e3);return()=>{q(0),clearInterval(de),p.stop()}},[d]);const ce=e=>{let t=(e%60).toString().padStart(2,"0"),a=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+a+":"+t},I=async()=>{var t,a;if($)return f("info","Returning since an image is currently uploading");if(L&&await c("toggleFlashlight",{toggled:!0}),o=="Video"){await c("Camera",{action:"toggleHud",toggled:d}),oe(r=>!r);return}await c("Camera",{action:"toggleHud",toggled:!1}),(a=(t=O.Settings.value)==null?void 0:t.sound)!=null&&a.silent||O.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),X(!0),x.IndicatorVisible.set(!1),S(!0),f("info","Uploading image, converting to blob");const e=await new Promise(r=>b.current.toBlob(r,m.imageOptions.mime,m.imageOptions.quality));try{await Y(e,!1),f("info","Image uploaded successfully"),S(!1),x.IndicatorVisible.set(!0)}catch(r){f("error","Could not upload image",r),S(!1),M(r.message),x.IndicatorVisible.set(!0),await new Promise(C=>setTimeout(C,1e4)),M(null)}X(!1),await c("Camera",{action:"toggleHud",toggled:!0})};return n(J,{children:g("div",{className:"camera-container",children:[g("div",{className:"camera-header",children:[n("div",{className:"flash",onClick:()=>H(e=>!e),children:!d&&L?n(Ae,{}):n(Ie,{})}),o==="Video"&&g(J,{children:[n("div",{className:"timer",children:ce(Q)}),n("span",{})]})]}),g("div",{className:`camera-body ${o=="Landscape"?"rotate":""}`,children:[n("canvas",{ref:b,style:{visibility:ne?"hidden":"visible"}}),$&&g("div",{className:"loading",children:[n(Ce,{size:80,speed:1,color:"#ffffff"}),n("div",{className:"uploading",ref:B,children:"Uploading..."})]}),W&&n("div",{className:"loading",children:g("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua",n("br",{}),n("br",{}),W]})})]}),g("div",{className:"camera-bottom",children:[n("div",{className:"camera-types",style:ie,children:u.map((e,t)=>n("div",{className:`${o===e&&"active"}`,onClick:()=>E(e),children:ee(`APPS.CAMERA.${e.toUpperCase()}`)},t))}),g("div",{className:"camera-buttons",children:[n("div",{className:"image-gallery",ref:z,onClick:()=>{!j&&!P||(c("Camera",{action:"close"}),R(0),O.App.set({name:"Photos"}))}}),n("div",{className:"camera-button",onClick:()=>I(),children:n("div",{className:"camera-button-container",children:n("div",{className:`camera-button-inner ${o=="Video"&&`${o} ${d==!0&&"Recording"}`}`})})}),n("div",{className:"flip-camera",onClick:()=>{G(e=>!e)},children:n(ke,{})})]})]})]})})}export{Oe as default};
