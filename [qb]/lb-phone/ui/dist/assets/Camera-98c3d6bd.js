import{r as n,j as o,F as _,a as S}from"./jsx-runtime-f40812bf.js";import{r as ge,Q as he,v as pe,w as ve,f as i,u as Se,S as w,n as F,R as ee,d as f,U as be,b as j,C as x,V as ye,L as te,y as Ce,z as we,W as Pe,g as Re}from"./Phone-6f7ce284.js";import{u as P,L as Ae,M as Ie,N as ke}from"./index.esm-3d32a72b.js";import{r as ae}from"./number-28525126.js";function Fe(){const d=P(Re),{Placement:re}=n.useContext(ge),ne=P(x.CameraComponent),M=P(w.Unlocked),H=P(w.PassedFaceId),$=P(w.Visible),se=P(w.LockScreenVisible),[Ne,R]=re.PhoneRotation,[z,b]=n.useState(!1),[c,E]=n.useState("Photo"),[L,W]=n.useState(!1),[oe,X]=n.useState(!1),[ie,O]=n.useState(!1),[A,G]=n.useState(!1),[u,ce]=n.useState(!1),[Q,q]=n.useState(0),[le,B]=n.useState({}),T=n.useRef(null),U=n.useRef(null),y=n.useRef(null),l=n.useRef(null),I=n.useRef(null),m=["Video","Photo","Landscape"];n.useEffect(()=>{if(!y.current||l.current)return;let e=new he(y.current);l.current=e},[y.current,$]),n.useEffect(()=>(pe("Camera").then(e=>{e&&(I.current=e)}),()=>{l.current&&l.current.destroy(),I.current&&ve("Camera"),ne||i("Camera",{action:"close"})}),[]),Se("camera:usedCommand",e=>{switch(e){case"toggleTaking":k();break;case"toggleFlip":G(t=>!t);break;case"toggleFlash":W(t=>!t);break;case"leftMode":if(u)return;E(t=>{const a=m.indexOf(t);return a===0?m[m.length-1]:m[a-1]});break;case"rightMode":if(u)return;E(t=>{const a=m.indexOf(t);return a===m.length-1?m[0]:m[a+1]});break}}),n.useEffect(()=>{if(!U.current)return;let e=[];const a=setInterval(()=>{e.length>2&&(e=[]),e.push("."),U.current.innerText=te("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(a)},[z]);const V=(e,t)=>{if(t===void 0&&(t=Ce(e)),t){const a=document.createElement("video");a.src=e,a.muted=!0,a.play();const r=document.createElement("canvas");if(!r)return;a.addEventListener("loadeddata",()=>{r.width=a.videoWidth,r.height=a.videoHeight,r.getContext("2d").drawImage(a,0,0,r.width,r.height);const h=r.toDataURL("image/png");T.current.style.backgroundImage=`url(${h})`,F.APPS.CAMERA.lastImage.set(h),r.remove(),a.remove()})}else T.current.style.backgroundImage=`url(${e})`,F.APPS.CAMERA.lastImage.set(e)};n.useEffect(()=>{if(i("Camera",{action:$?"open":"close"}),se||!M)w.Flashlight&&(i("toggleFlashlight",{toggled:!1}),w.Flashlight.set(!1)),R(0),E("Photo");else{if(i("Camera",{action:"flipCamera",value:A}),F.APPS.CAMERA.lastImage.value)return V(F.APPS.CAMERA.lastImage.value);i("Camera",{action:"getLastImage"}).then(e=>{e&&V(e)})}},[M,H,$]),n.useEffect(()=>{if(u)return;switch(c){case"Landscape":B({marginRight:"9rem"}),R(90);break;case"Video":R(0),B({marginLeft:"12rem"});break;default:R(0),B({marginLeft:"3rem"});break}c==="Landscape"?l.current&&l.current.resizeByAspect(16/9):(c==="Video"||c==="Photo")&&l.current&&l.current.resizeByAspect(3/4),i("Camera",{action:"toggleLandscape",toggled:c==="Landscape"}),i("Camera",{action:"toggleVideo",toggled:c==="Video"});const e=window.innerWidth;e>1920&&l.current.setQuality(1920/e),c==="Photo"&&A?l.current.setXOffset(-.2):l.current.setXOffset(0)},[c]),n.useEffect(()=>{i("Camera",{action:"flipCamera",value:A}),!u&&(c=="Photo"&&A?l.current.setXOffset(-.2):l.current.setXOffset(0))},[M,A]);const K=n.useRef(!0),J=async(e,t)=>{const a=ae(e.size/1e3,2);L&&i("toggleFlashlight",{toggled:!1});try{const r=await we(t?"Video":"Image",e);return t?V(URL.createObjectURL(e),!0):V(r),f("info",`Saved ${t?"video":"photo"} to gallery (${a}kb) - ${r}`),await Pe(r,a),!0}catch(r){throw r}};n.useEffect(()=>{if(K.current){K.current=!1;return}if(L&&!u&&i("toggleFlashlight",{toggled:!1}),!u)return;const e=y.current.captureStream(d.videoOptions.fps),t=new AudioContext,a=new MediaStreamAudioDestinationNode(t);I.current?t.createMediaStreamSource(I.current).connect(a):t.createOscillator().connect(a);let r;if(d.recordNearbyVoices){r=d.ice?new ee({config:{iceTransportPolicy:"relay",iceServers:d.ice}}):new ee,r.on("open",g=>{i("Camera",{action:"setRecordingPeerId",peerId:g}),f("info","Listening for nearby voices")});const s=document.createElement("canvas");s.width=1,s.height=1;const v=s.captureStream(0);r.on("call",g=>{g.answer(v),g.on("stream",C=>{f("info","Received nearby voice");const N=new Audio;N.srcObject=C,N.volume=0,N.play(),new MediaStreamAudioSourceNode(t,{mediaStream:C}).connect(a)}),g.on("close",()=>{f("info","Stopped receiving nearby voice")})})}const h=[e.getVideoTracks()[0]];(I.current||d.recordNearbyVoices)&&h.unshift(a.stream.getAudioTracks()[0]);const ue=new MediaStream(h),p=new MediaRecorder(ue,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:d.videoOptions.bitrate*8*1e3});let D=0;const fe=p.audioBitsPerSecond+p.videoBitsPerSecond,Y=setInterval(()=>{const s=(Date.now()-D)/1e3,g=fe*s/8/1024/1024,C=ae(g,2);C>=d.videoOptions.size&&(f("info",`Video file size limit reached (${C}mb)`),clearInterval(Y),k())},100);let Z=[];p.ondataavailable=s=>{var v;((v=s==null?void 0:s.data)==null?void 0:v.size)>0&&Z.push(s.data)},p.onerror=s=>{f("error","error recording:",s)},p.onstop=async()=>{clearInterval(Y);let s=Date.now()-D,v=new Blob(Z,{type:"video/webm"});t.close(),b(!0),r&&(r.destroy(),f("info","Destroyed peer connection"),i("Camera",{action:"endedRecording"}));const g=await be(v,s,{logger:!1});try{await J(g,!0),b(!1)}catch{b(!1),O(!0),await new Promise(N=>setTimeout(N,1e4)),O(!1)}},D=Date.now(),p.start();const me=setInterval(()=>{if(Q>=d.videoOptions.duration)return k();q(s=>s+1>=d.videoOptions.duration?(k(),0):s+1)},1e3);return()=>{q(0),clearInterval(me),p.stop()}},[u]);const de=e=>{let t=(e%60).toString().padStart(2,"0"),a=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+a+":"+t},k=async()=>{var t,a;if(z)return f("info","Returning since an image is currently uploading");if(L&&await i("toggleFlashlight",{toggled:!0}),c=="Video"){await i("Camera",{action:"toggleHud",toggled:u}),ce(r=>!r);return}await i("Camera",{action:"toggleHud",toggled:!1}),(a=(t=j.Settings.value)==null?void 0:t.sound)!=null&&a.silent||j.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),X(!0),x.IndicatorVisible.set(!1),b(!0),f("info","Uploading image, converting to blob");const e=await new Promise(r=>y.current.toBlob(r,d.imageOptions.mime,d.imageOptions.quality));try{await J(e,!1),f("info","Image uploaded successfully"),b(!1),x.IndicatorVisible.set(!0)}catch{b(!1),O(!0),x.IndicatorVisible.set(!0),await new Promise(h=>setTimeout(h,1e4)),O(!1)}X(!1),await i("Camera",{action:"toggleHud",toggled:!0})};return o(_,{children:S("div",{className:"camera-container",children:[S("div",{className:"camera-header",children:[o("div",{className:"flash",onClick:()=>W(e=>!e),children:!u&&L?o(Ae,{}):o(Ie,{})}),c==="Video"&&S(_,{children:[o("div",{className:"timer",children:de(Q)}),o("span",{})]})]}),S("div",{className:`camera-body ${c=="Landscape"?"rotate":""}`,children:[o("canvas",{ref:y,style:{visibility:oe?"hidden":"visible"}}),z&&S("div",{className:"loading",children:[o(ye,{size:80,speed:1,color:"#ffffff"}),o("div",{className:"uploading",ref:U,children:"Uploading..."})]}),ie&&o("div",{className:"loading",children:o("div",{className:"uploading",children:"Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua"})})]}),S("div",{className:"camera-bottom",children:[o("div",{className:"camera-types",style:le,children:m.map((e,t)=>o("div",{className:`${c===e&&"active"}`,onClick:()=>E(e),children:te(`APPS.CAMERA.${e.toUpperCase()}`)},t))}),S("div",{className:"camera-buttons",children:[o("div",{className:"image-gallery",ref:T,onClick:()=>{!H&&!M||(i("Camera",{action:"close"}),R(0),j.App.set({name:"Photos"}))}}),o("div",{className:"camera-button",onClick:()=>k(),children:o("div",{className:"camera-button-container",children:o("div",{className:`camera-button-inner ${c=="Video"&&`${c} ${u==!0&&"Recording"}`}`})})}),o("div",{className:"flip-camera",onClick:()=>{G(e=>!e)},children:o(ke,{})})]})]})]})})}export{Fe as default};
