var N=Object.defineProperty;var C=(n,r,o)=>r in n?N(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o;var E=(n,r,o)=>(C(n,typeof r!="symbol"?r+"":r,o),o);import{r as d,j as v,R as w,F as b,a as x}from"./jsx-runtime-f40812bf.js";import{r as R}from"./index-0dd4a6fb.js";import{f as p,d as c,u as g,$ as S,P as $,a as k}from"./Phone-3c5ec2e3.js";import"./index.esm-497ba86e.js";import"./number-28525126.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const m of s.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function o(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerpolicy&&(s.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?s.credentials="include":t.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(t){if(t.ep)return;t.ep=!0;const s=o(t);fetch(t.href,s)}})();var y={},V=R;y.createRoot=V.createRoot,y.hydrateRoot=V.hydrateRoot;const L=()=>{const[n,r]=d.useState(null);return d.useEffect(()=>{p("voice:getConfig").then(o=>{if(!o)return c("error","VoiceProvider: No config found");r(o)})},[]),n!=null&&n.recordNearbyVoices?v(M,{config:n}):null},M=({config:n})=>{const r=d.useRef(null),[o,a]=d.useState([]),[t,s]=d.useState(!0),m=async()=>{var i;if(c("info","VoiceProvider: Creating audio stream"),r.current)return r.current;const e=await((i=navigator.mediaDevices)==null?void 0:i.getUserMedia({audio:{autoGainControl:!1,noiseSuppression:!1,echoCancellation:!1}}));return c("info","VoiceProvider: Got audio stream"),r.current=e,p("isTalking").then(u=>{s(!u)}),e};return d.useEffect(()=>{r.current&&(c("info",`VoiceProvider: ${t?"muting":"unmuting"} audio stream`),o.forEach(e=>{e.gainNode.gain.value=t?0:e.volume,c("info",`VoiceProvider: Set volume to ${t?0:e.volume} for channel ${e.id}`)}))},[t]),g("camera:toggleMicrophone",e=>{s(!e)}),d.useEffect(()=>{var e;o.length===0&&r.current&&((e=r.current)==null||e.getTracks().forEach(i=>i.stop()),r.current=null,c("info","VoiceProvider: Stopped audio stream"))},[o]),g("voice:joinChannel",async e=>{if(o.find(f=>f.id===e.channel))return c("warning","VoiceProvider: Already connected to channel "+e.channel);try{await m()}catch{c("error","VoiceProvider: Failed to get audio stream")}if(!r.current)return c("warning","VoiceProvider: No audio stream");c("info","Joining voice channel "+JSON.stringify(e));let i=new AudioContext,u=i.createMediaStreamSource(r.current),l=i.createMediaStreamDestination(),h=i.createGain();h.gain.value=e.volume,u.connect(h),h.connect(l),p("isTalking").then(f=>{f||(h.gain.value=0)});const P=n!=null&&n.rtc?new S({config:n.rtc}):new S;P.on("open",()=>{P.call(e.channel,l.stream),a(f=>[...f,{id:e.channel,volume:e.volume,peer:P,gainNode:h,audioCtx:i}])})}),g("voice:leaveChannel",e=>{c("info","Leaving voice channel "+e);const i=o.find(u=>u.id===e);if(!i)return c("warning","VoiceProvider: Not connected to channel "+e);i.audioCtx.close(),i.peer.destroy(),a(u=>u.filter(l=>l.id!==e))}),g("voice:setVolume",e=>{c("info","Setting volume for channel "+e.channel+" to "+e.volume);const i=o.find(u=>u.id===e.channel);if(!i)return c("warning","VoiceProvider: Not connected to channel "+e.channel);t?c("info","VoiceProvider: Not setting volume because mic is muted"):i.gainNode.gain.value=e.volume,a(u=>u.map(l=>l.id===e.channel?{...l,volume:e.volume}:l))}),null};class D extends w.Component{constructor(){super(...arguments);E(this,"state",{hasError:!1})}static getDerivedStateFromError(o){return{hasError:!0}}componentDidCatch(o,a){this.props.enabled&&this.logError(o,a)}logError(o,a){console.error("Phone crashed:",o,a),p("logError",{error:o.message,stack:o.stack,componentStack:a.componentStack})}render(){return this.props.enabled?this.state.hasError?(window.location.reload(),null):this.props.children:this.props.children}}y.createRoot(document.getElementById("root")).render(v(b,{children:x(D,{enabled:!0,children:[v($,{children:v(k,{})}),v(L,{})]})}));
