var N=Object.defineProperty;var C=(n,r,o)=>r in n?N(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o;var E=(n,r,o)=>(C(n,typeof r!="symbol"?r+"":r,o),o);import{r as f,j as v,R as w,F as x,a as R}from"./jsx-runtime-f40812bf.js";import{r as k}from"./index-0dd4a6fb.js";import{f as p,d as c,u as g,$ as S,P as $,a as b}from"./Phone-6f7ce284.js";import"./index.esm-3d32a72b.js";import"./number-28525126.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))u(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const m of a.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&u(m)}).observe(document,{childList:!0,subtree:!0});function o(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerpolicy&&(a.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?a.credentials="include":t.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function u(t){if(t.ep)return;t.ep=!0;const a=o(t);fetch(t.href,a)}})();var y={},V=k;y.createRoot=V.createRoot,y.hydrateRoot=V.hydrateRoot;const L=()=>{const[n,r]=f.useState(null);return f.useEffect(()=>{p("voice:getConfig").then(o=>{if(!o)return c("error","VoiceProvider: No config found");r(o)})},[]),n!=null&&n.recordNearbyVoices?v(M,{config:n}):null},M=({config:n})=>{const r=f.useRef(null),[o,u]=f.useState([]),[t,a]=f.useState(!0),m=async()=>{var e;if(c("info","VoiceProvider: Creating audio stream"),r.current)return r.current;try{const i=await((e=navigator.mediaDevices)==null?void 0:e.getUserMedia({audio:{autoGainControl:!1,noiseSuppression:!1,echoCancellation:!1}}));return c("info","VoiceProvider: Got audio stream"),u(s=>{var l;return s.length===0&&(c("info","VoiceProvider: No connected peers, stopping audio stream"),(l=r.current)==null||l.getTracks().forEach(d=>d.stop()),r.current=null),s}),r.current=i,p("isTalking").then(s=>{a(!s)}),i}catch{return c("error","VoiceProvider: Failed to get audio stream"),null}};return f.useEffect(()=>{r.current&&(c("info",`VoiceProvider: ${t?"muting":"unmuting"} audio stream`),o.forEach(e=>{e.gainNode.gain.value=t?0:e.volume,c("info",`VoiceProvider: Set volume to ${t?0:e.volume} for channel ${e.id}`)}))},[t]),g("camera:toggleMicrophone",e=>{a(!e)}),f.useEffect(()=>{var e;o.length===0&&r.current&&((e=r.current)==null||e.getTracks().forEach(i=>i.stop()),r.current=null,c("info","VoiceProvider: Stopped audio stream"))},[o]),g("voice:joinChannel",async e=>{if(await m(),!r.current)return c("warning","VoiceProvider: No audio stream");if(o.find(h=>h.id===e.channel))return c("warning","VoiceProvider: Already connected to channel "+e.channel);c("info","Joining voice channel "+JSON.stringify(e));let i=new AudioContext,s=i.createMediaStreamSource(r.current),l=i.createMediaStreamDestination(),d=i.createGain();d.gain.value=e.volume,s.connect(d),d.connect(l),p("isTalking").then(h=>{h||(d.gain.value=0)});const P=n!=null&&n.ice?new S({config:{iceTransportPolicy:"relay",iceServers:n==null?void 0:n.ice}}):new S;P.on("open",()=>{P.call(e.channel,l.stream),u(h=>[...h,{id:e.channel,volume:e.volume,peer:P,gainNode:d,audioCtx:i}])})}),g("voice:leaveChannel",e=>{c("info","Leaving voice channel "+e);const i=o.find(s=>s.id===e);if(!i)return c("warning","VoiceProvider: Not connected to channel "+e);i.audioCtx.close(),i.peer.destroy(),u(s=>s.filter(l=>l.id!==e))}),g("voice:setVolume",e=>{c("info","Setting volume for channel "+e.channel+" to "+e.volume);const i=o.find(s=>s.id===e.channel);if(!i)return c("warning","VoiceProvider: Not connected to channel "+e.channel);t?c("info","VoiceProvider: Not setting volume because mic is muted"):i.gainNode.gain.value=e.volume,u(s=>s.map(l=>l.id===e.channel?{...l,volume:e.volume}:l))}),null};class D extends w.Component{constructor(){super(...arguments);E(this,"state",{hasError:!1})}static getDerivedStateFromError(o){return{hasError:!0}}componentDidCatch(o,u){this.logError(o,u)}logError(o,u){console.error("Phone crashed:",o,u),p("logError",{error:o.message,stack:o.stack,componentStack:u.componentStack})}render(){return this.state.hasError?(window.location.reload(),null):this.props.children}}y.createRoot(document.getElementById("root")).render(v(x,{children:R(D,{children:[v($,{children:v(b,{})}),v(L,{})]})}));
